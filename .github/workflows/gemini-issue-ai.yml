name: æä¾›AIæé—®æç¤ºè¯
on:
  # è§¦å‘æ¡ä»¶1ï¼šæ–°å»ºIssueï¼ˆå¯é€‰ä¿ç•™ï¼‰
  issues:
    types: [opened]
  # è§¦å‘æ¡ä»¶2ï¼šæ–°å¢Issueè¯„è®ºï¼ˆæ ¸å¿ƒï¼Œæ£€æµ‹@issue_bot_cnï¼‰
  issue_comment:
    types: [created]

jobs:
  provide-ai-prompt:
    runs-on: ubuntu-latest
    permissions:
      issues: write  # è¯„è®ºIssueæƒé™
      contents: read # è¯»å–ä»“åº“å†…å®¹æƒé™
    # ä»…æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶æ‰§è¡Œï¼šè¯„è®ºå«@issue_bot_cn æˆ– æ–°å»ºIssueï¼ˆå¯é€‰ï¼‰
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@issue_bot_cn')) ||
      (github.event_name == 'issues' && github.event.action == 'opened')
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: è·å–å†å²Issueä½œä¸ºå‚è€ƒ
        id: get_issues
        uses: actions/github-script@v7
        with:
          script: |
            // è·å–æœ€è¿‘30æ¡å·²å…³é—­çš„Issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              per_page: 30
            });
            // ç”Ÿæˆå†å²Issueé“¾æ¥åˆ—è¡¨
            const issueLinks = issues.data.map(issue =>
              `#${issue.number}ï¼š${issue.title} - https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${issue.number}`
            ).join('\n');
            core.setOutput('issue_links', issueLinks);

      - name: ç”Ÿæˆå¹¶å‘å¸ƒAIæé—®æç¤ºè¯
        uses: actions/github-script@v7
        with:
          script: |
            // è·å–å½“å‰Issueä¿¡æ¯
            const issueNumber = context.issue.number;
            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body;
            const issueLink = `https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${issueNumber}`;
            const docLink = 'https://ais-bench-benchmark-rf.readthedocs.io/';
            const historicalIssues = `${{ steps.get_issues.outputs.issue_links }}`;

            // ç”Ÿæˆæç¤ºè¯
            const prompt = `ä½ ç°åœ¨éœ€è¦è§£å†³ä¸€ä¸ªå…³äº AISBench/benchmark ä»“åº“çš„issueï¼Œè¯·åŸºäºä»¥ä¸‹ä¿¡æ¯åˆ†æå¹¶æä¾›è§£å†³æ–¹æ¡ˆï¼š\n\nã€å½“å‰é—®é¢˜ã€‘\nIssue é“¾æ¥ï¼š${issueLink}\næ ‡é¢˜ï¼š${issueTitle}\nå†…å®¹ï¼š${issueBody ? issueBody.substring(0, 1000) : 'æ— '}\n\nã€å†å²ç›¸å…³Issueå‚è€ƒã€‘\n${historicalIssues}\n\nã€å®˜æ–¹æ–‡æ¡£ã€‘\n${docLink}\n\nè¯·ç»“åˆä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œæä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆæˆ–å»ºè®®ã€‚`;

            // ç”ŸæˆAIåŠ©æ‰‹é“¾æ¥åˆ—è¡¨
            const aiAgents = `\n\nå¸¸ç”¨AIåŠ©æ‰‹é“¾æ¥ï¼š\n- è±†åŒ…ï¼šhttps://www.doubao.com/\n- ChatGPTï¼šhttps://chat.openai.com/\n- æ–‡å¿ƒä¸€è¨€ï¼šhttps://yiyan.baidu.com/\n- é€šä¹‰åƒé—®ï¼šhttps://tongyi.aliyun.com/`;

            // å‘å¸ƒè¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ğŸ¤– ä¸ºäº†æ›´å¥½åœ°å¸®åŠ©ä½ è§£å†³é—®é¢˜ï¼Œæˆ‘ä»¬ä¸ºä½ å‡†å¤‡äº† AI æé—®æç¤ºè¯ã€‚ä½ å¯ä»¥å¤åˆ¶ä»¥ä¸‹å†…å®¹åˆ°ä»»æ„ AI åŠ©æ‰‹ä¸­ï¼ˆå¦‚è±†åŒ…ã€ChatGPT ç­‰ï¼‰è·å–ä¸“ä¸šè§£ç­”ï¼š\n\n\`\`\`\n${prompt}\n\`\`\`${aiAgents}`
            });