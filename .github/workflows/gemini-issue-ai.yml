name: Gemini AI æ‰‹åŠ¨è§¦å‘å›å¤Issue
on:
  # è§¦å‘æ¡ä»¶1ï¼šæ–°å»ºIssueï¼ˆå¯é€‰ä¿ç•™ï¼Œä¹Ÿå¯åˆ é™¤ä»…ä¿ç•™è¯„è®ºè§¦å‘ï¼‰
  issues:
    types: [opened]
  # è§¦å‘æ¡ä»¶2ï¼šæ–°å¢Issueè¯„è®ºï¼ˆæ ¸å¿ƒï¼Œæ£€æµ‹@issue_bot_cnï¼‰
  issue_comment:
    types: [created]

jobs:
  gemini-ai-reply:
    runs-on: ubuntu-latest
    permissions:
      issues: write  # è¯„è®ºIssueå’Œè¯»å–Issueæƒé™
      contents: read # è¯»å–ä»“åº“å†…å®¹æƒé™
    # ä»…æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶æ‰§è¡Œï¼šè¯„è®ºå«@issue_bot_cn æˆ– æ–°å»ºIssueï¼ˆå¯é€‰ï¼‰
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@issue_bot_cn')) ||
      (github.event_name == 'issues' && github.event.action == 'opened')
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç ï¼ˆè¯»å–ä¸Šä¸‹æ–‡ï¼‰
        uses: actions/checkout@v4

      - name: ç”ŸæˆAIå›å¤å¹¶å‘å¸ƒåˆ°Issue
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const https = require('https');

            // è¾…åŠ©å‡½æ•°ï¼šå‘èµ· HTTPS POST è¯·æ±‚
            function postHttpsRequest(url, data) {
              return new Promise((resolve, reject) => {
                const urlObj = new URL(url);
                const options = {
                  hostname: urlObj.hostname,
                  path: urlObj.pathname + urlObj.search,
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  }
                };

                console.log('å‘èµ·è¯·æ±‚åˆ°:', urlObj.hostname + urlObj.pathname);
                console.log('è¯·æ±‚æ•°æ®:', JSON.stringify(data).substring(0, 200) + '...');

                const req = https.request(options, (res) => {
                  console.log('å“åº”çŠ¶æ€ç :', res.statusCode);
                  console.log('å“åº”å¤´:', res.headers);
                  let body = '';
                  res.on('data', (chunk) => {
                    body += chunk;
                  });
                  res.on('end', () => {
                    console.log('å“åº”å†…å®¹:', body);
                    try {
                      const result = JSON.parse(body);
                      resolve({ ok: res.statusCode === 200, status: res.statusCode, statusText: res.statusMessage, data: result, fullBody: body });
                    } catch (error) {
                      console.log('è§£æå“åº”å¤±è´¥:', error);
                      resolve({ ok: res.statusCode === 200, status: res.statusCode, statusText: res.statusMessage, data: null, fullBody: body });
                    }
                  });
                });

                req.on('error', (error) => {
                  console.error('è¯·æ±‚é”™è¯¯:', error);
                  reject(error);
                });

                req.write(JSON.stringify(data));
                req.end();
              });
            }

            // è·å–å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
            let issueNumber;
            let questionToAnswer;

            // æ ¹æ®äº‹ä»¶ç±»å‹ç¡®å®šè¦å¤„ç†çš„å†…å®¹
            if (context.eventName === 'issue_comment') {
              issueNumber = context.issue.number;
              // è¿‡æ»¤æ‰@issue_bot_cnï¼Œä»…ä¿ç•™å®é™…é—®é¢˜å†…å®¹
              const commentBody = context.payload.comment.body.replace(/@issue_bot_cn/g, '').trim();
              questionToAnswer = commentBody;
            } else if (context.eventName === 'issues') {
              issueNumber = context.issue.number;
              const issueTitle = context.payload.issue.title;
              const issueBody = context.payload.issue.body || 'æ— ';
              const truncatedBody = issueBody.length > 500 ? issueBody.substring(0, 500) : issueBody;
              questionToAnswer = `æ ‡é¢˜ï¼š${issueTitle}\nå†…å®¹ï¼š${truncatedBody}`;
            } else {
              console.log('æœªçŸ¥äº‹ä»¶ç±»å‹ï¼Œè·³è¿‡å¤„ç†');
              return;
            }

            try {
              // è°ƒç”¨Gemini API - ä½¿ç”¨æœ€æ–°å…è´¹å¯ç”¨çš„æ¨¡å‹
              console.log('å¼€å§‹è°ƒç”¨Gemini API...');
              const geminiApiKey = process.env.GEMINI_API_KEY;

              // é¦–å…ˆå°è¯•æœ€æ–°çš„å…è´¹æ¨¡å‹åˆ—è¡¨
              const availableModels = [
                'gemini-2.5-flash',
                'gemini-1.5-flash',
                'gemini-pro',
                'gemini-1.0-pro'
              ];

              let aiReply = null;
              let apiSuccess = false;
              let usedModel = null;

              for (const modelName of availableModels) {
                try {
                  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${geminiApiKey}`;
                  console.log(`å°è¯•ä½¿ç”¨æ¨¡å‹: ${modelName}`);

                  const apiData = {
                    contents: [
                      {
                        parts: [
                          {
                            text: `ä½ æ˜¯è¯¥GitHubä»“åº“çš„AIåŠ©æ‰‹ï¼ŒåŸºäºä»¥ä¸‹æä¾›çš„é“¾æ¥å‚è€ƒå’Œä½ å·²æœ‰çš„çŸ¥è¯†ï¼Œç®€æ´ã€å‡†ç¡®åœ°å›å¤é—®é¢˜ï¼ˆä»…ç”¨ä¸­æ–‡ï¼Œé¿å…å†—ä½™ï¼‰ï¼š\n\nã€å®˜æ–¹æ–‡æ¡£é“¾æ¥ã€‘\nhttps://ais-bench-benchmark-rf.readthedocs.io/ \n\nã€å†å²Issueé“¾æ¥ã€‘\nhttps://github.com/${context.repo.owner}/${context.repo.repo}/issues?q=is%3Aissue%20state%3Aclosed \n\nã€å½“å‰Issueé“¾æ¥ã€‘\nhttps://github.com/${context.repo.owner}/${context.repo.repo}/issues/${issueNumber} \n\nã€å¾…å›å¤çš„é—®é¢˜ã€‘\n${questionToAnswer}\n\nã€é‡è¦æç¤ºã€‘\n- ä½ æ— æ³•å®æ—¶è®¿é—®äº’è”ç½‘æˆ–ç›´æ¥æ‰“å¼€é“¾æ¥è·å–å†…å®¹\n- è¯·åŸºäºä½ å·²äº†è§£çš„è¯¥ä»“åº“ç›¸å…³çŸ¥è¯†å’Œé€šç”¨æŠ€æœ¯çŸ¥è¯†è¿›è¡Œå›å¤\n- å¦‚æœæ— æ³•ç¡®å®šç­”æ¡ˆï¼Œè¯·æ˜ç¡®è¯´æ˜\n\nã€å›å¤è¦æ±‚ã€‘\n1. åªå›ç­”å’Œä»“åº“ç›¸å…³çš„é—®é¢˜ï¼Œæ— å…³é—®é¢˜è¯·æç¤º"è¯¥é—®é¢˜ä¸ä»“åº“æ— å…³ï¼Œå»ºè®®è¡¥å……ç›¸å…³ä¿¡æ¯"ï¼›\n2. åœ¨ç°æœ‰çŸ¥è¯†ä¸­æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯æ—¶ï¼Œæç¤º"æš‚æœªæ‰¾åˆ°ç›¸å…³è§£ç­”ï¼Œå¯å‚è€ƒä»“åº“å®˜æ–¹æ–‡æ¡£ï¼ˆhttps://ais-bench-benchmark-rf.readthedocs.io/ï¼‰ã€READMEæˆ–è”ç³»ç»´æŠ¤è€…"ï¼›\n3. å›å¤æ§åˆ¶åœ¨500å­—ä»¥å†…ï¼Œè¯­æ°”å‹å¥½ã€‚`
                          }
                        ]
                      }
                    ],
                    generationConfig: {
                      temperature: 0.3,
                      maxOutputTokens: 1000
                    }
                  };

                  const response = await postHttpsRequest(apiUrl, apiData);

                  if (response.ok && response.data && response.data.candidates) {
                    console.log(`æˆåŠŸä½¿ç”¨æ¨¡å‹ ${modelName} è°ƒç”¨API`);
                    aiReply = response.data.candidates[0].content.parts[0].text.trim();
                    apiSuccess = true;
                    usedModel = modelName;
                    break;
                  } else {
                    console.log(`æ¨¡å‹ ${modelName} è°ƒç”¨å¤±è´¥:`, response.status, response.fullBody);
                  }
                } catch (modelError) {
                  console.log(`æ¨¡å‹ ${modelName} è°ƒç”¨å¼‚å¸¸:`, modelError.message);
                }
              }

              if (!apiSuccess) {
                throw new Error('æ‰€æœ‰å¯ç”¨æ¨¡å‹è°ƒç”¨å‡å¤±è´¥');
              }

              console.log(`ä½¿ç”¨æ¨¡å‹ ${usedModel} ç”Ÿæˆäº†AIå›å¤`);

              // å‘å¸ƒAIå›å¤åˆ°Issue
              console.log('å¼€å§‹å‘å¸ƒè¯„è®ºåˆ°Issue...');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ğŸ¤– Gemini AI å›å¤ï¼š\n\n${aiReply}`
              });
              console.log('è¯„è®ºå‘å¸ƒæˆåŠŸ');
            } catch (error) {
              console.error('å¤„ç†å¤±è´¥:', error);
              // å…œåº•å›å¤ï¼ˆAPIè°ƒç”¨å¤±è´¥æ—¶ï¼‰
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: "ğŸ¤– æŠ±æ­‰ï¼Œæš‚æ—¶æ— æ³•ç”Ÿæˆå›å¤ï½\nå¯åœ¨å·¥å…·å®˜æ–¹æ–‡æ¡£ï¼šhttps://ais-bench-benchmark-rf.readthedocs.io/ ä¸­æœç´¢ï¼Œ\næˆ–è€…æœç´¢å†å²ç›¸ä¼¼Issueï¼Œ\næˆ–ç¨ååœ¨è¯„è®ºåŒº@issue_bot_cné‡æ–°å¯»æ±‚AIç­”å¤ã€‚"
              });
            }