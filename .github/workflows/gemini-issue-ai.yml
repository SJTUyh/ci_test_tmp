name: Gemini AI æ‰‹åŠ¨è§¦å‘å›å¤Issue
on:
  # è§¦å‘æ¡ä»¶1ï¼šæ–°å»ºIssueï¼ˆå¯é€‰ä¿ç•™ï¼Œä¹Ÿå¯åˆ é™¤ä»…ä¿ç•™è¯„è®ºè§¦å‘ï¼‰
  issues:
    types: [opened]
  # è§¦å‘æ¡ä»¶2ï¼šæ–°å¢Issueè¯„è®ºï¼ˆæ ¸å¿ƒï¼Œæ£€æµ‹@issue_bot_cnï¼‰
  issue_comment:
    types: [created]

jobs:
  gemini-ai-reply:
    runs-on: ubuntu-latest
    permissions:
      issues: write  # è¯„è®ºIssueå’Œè¯»å–Issueæƒé™
      contents: read # è¯»å–ä»“åº“å†…å®¹æƒé™
    # ä»…æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶æ‰§è¡Œï¼šè¯„è®ºå«@issue_bot_cn æˆ– æ–°å»ºIssueï¼ˆå¯é€‰ï¼‰
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@issue_bot_cn')) ||
      (github.event_name == 'issues' && github.event.action == 'opened')
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç ï¼ˆè¯»å–ä¸Šä¸‹æ–‡ï¼‰
        uses: actions/checkout@v4

      - name: ç”ŸæˆAIå›å¤å¹¶å‘å¸ƒåˆ°Issue
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const https = require('https');

            // è¾…åŠ©å‡½æ•°ï¼šå‘èµ· HTTPS POST è¯·æ±‚
            function postHttpsRequest(url, data) {
              return new Promise((resolve, reject) => {
                const urlObj = new URL(url);
                const options = {
                  hostname: urlObj.hostname,
                  path: urlObj.pathname + urlObj.search,
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  }
                };

                console.log('å‘èµ·è¯·æ±‚åˆ°:', urlObj.hostname + urlObj.pathname);
                console.log('è¯·æ±‚æ•°æ®:', JSON.stringify(data).substring(0, 200) + '...');

                const req = https.request(options, (res) => {
                  console.log('å“åº”çŠ¶æ€ç :', res.statusCode);
                  console.log('å“åº”å¤´:', res.headers);
                  let body = '';
                  res.on('data', (chunk) => {
                    body += chunk;
                  });
                  res.on('end', () => {
                    console.log('å“åº”å†…å®¹:', body);
                    try {
                      const result = JSON.parse(body);
                      resolve({ ok: res.statusCode === 200, status: res.statusCode, statusText: res.statusMessage, data: result, fullBody: body });
                    } catch (error) {
                      console.log('è§£æå“åº”å¤±è´¥:', error);
                      resolve({ ok: res.statusCode === 200, status: res.statusCode, statusText: res.statusMessage, data: null, fullBody: body });
                    }
                  });
                });

                req.on('error', (error) => {
                  console.error('è¯·æ±‚é”™è¯¯:', error);
                  reject(error);
                });

                req.write(JSON.stringify(data));
                req.end();
              });
            }

            // è·å–å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
            let issueNumber;
            let questionToAnswer;

            // æ ¹æ®äº‹ä»¶ç±»å‹ç¡®å®šè¦å¤„ç†çš„å†…å®¹
            if (context.eventName === 'issue_comment') {
              issueNumber = context.issue.number;
              // è¿‡æ»¤æ‰@issue_bot_cnï¼Œä»…ä¿ç•™å®é™…é—®é¢˜å†…å®¹
              const commentBody = context.payload.comment.body.replace(/@issue_bot_cn/g, '').trim();
              questionToAnswer = commentBody;
            } else if (context.eventName === 'issues') {
              issueNumber = context.issue.number;
              const issueTitle = context.payload.issue.title;
              const issueBody = context.payload.issue.body || 'æ— ';
              const truncatedBody = issueBody.length > 500 ? issueBody.substring(0, 500) : issueBody;
              questionToAnswer = `æ ‡é¢˜ï¼š${issueTitle}\nå†…å®¹ï¼š${truncatedBody}`;
            } else {
              console.log('æœªçŸ¥äº‹ä»¶ç±»å‹ï¼Œè·³è¿‡å¤„ç†');
              return;
            }

            try {
              // è·å–å†å²Issueä½œä¸ºä¸Šä¸‹æ–‡ï¼ˆæœ€è¿‘30æ¡å·²å…³é—­çš„Issueï¼‰
              console.log('å¼€å§‹è·å–å†å²Issue...');
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed',
                per_page: 30
              });
              console.log('è·å–åˆ°å†å²Issueæ•°é‡:', issues.data.length);

              // ç²¾ç®€ä¸Šä¸‹æ–‡ï¼Œä¿ç•™æ ‡é¢˜+æ ¸å¿ƒå†…å®¹ï¼ˆé¿å…è¶…é•¿ï¼‰
              const issueContext = issues.data.map(issue =>
                `Issue #${issue.number}ï¼š${issue.title}\næ ¸å¿ƒå†…å®¹ï¼š${issue.body ? issue.body.substring(0, 300) : 'æ— '}`
              ).join('\n\n');

              // è°ƒç”¨Gemini API
              console.log('å¼€å§‹è°ƒç”¨Gemini API...');
              const geminiApiKey = process.env.GEMINI_API_KEY;
              const apiUrl = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;
              const apiData = {
                contents: [
                  {
                    parts: [
                      {
                        text: `ä½ æ˜¯è¯¥GitHubä»“åº“çš„AIåŠ©æ‰‹ï¼ŒåŸºäºä»¥ä¸‹å†å²Issueä¸Šä¸‹æ–‡å’Œå®˜æ–¹æ–‡æ¡£å‚è€ƒï¼Œç®€æ´ã€å‡†ç¡®åœ°å›å¤é—®é¢˜ï¼ˆä»…ç”¨ä¸­æ–‡ï¼Œé¿å…å†—ä½™ï¼‰ï¼š\n\nã€å®˜æ–¹æ–‡æ¡£å‚è€ƒã€‘\nhttps://ais-bench-benchmark-rf.readthedocs.io/ \n\nã€å†å²Issueä¸Šä¸‹æ–‡ã€‘\n${issueContext}\n\nã€å¾…å›å¤çš„é—®é¢˜ã€‘\n${questionToAnswer}\n\nã€å›å¤è¦æ±‚ã€‘\n1. åªå›ç­”å’Œä»“åº“ç›¸å…³çš„é—®é¢˜ï¼Œæ— å…³é—®é¢˜è¯·æç¤ºâ€œè¯¥é—®é¢˜ä¸ä»“åº“æ— å…³ï¼Œå»ºè®®è¡¥å……ç›¸å…³ä¿¡æ¯â€ï¼›\n2. ä¸Šä¸‹æ–‡æ— ç›¸å…³ä¿¡æ¯æ—¶ï¼Œæç¤ºâ€œæš‚æœªæ‰¾åˆ°ç›¸å…³è§£ç­”ï¼Œå¯å‚è€ƒä»“åº“å®˜æ–¹æ–‡æ¡£ï¼ˆhttps://ais-bench-benchmark-rf.readthedocs.io/ï¼‰ã€READMEæˆ–è”ç³»ç»´æŠ¤è€…â€ï¼›\n3. å›å¤æ§åˆ¶åœ¨500å­—ä»¥å†…ï¼Œè¯­æ°”å‹å¥½ã€‚`
                      }
                    ]
                  }
                ],
                generationConfig: {
                  temperature: 0.3,
                  maxOutputTokens: 500
                }
              };

              const response = await postHttpsRequest(apiUrl, apiData);

              if (!response.ok) {
                throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}`);
              }

              console.log('Gemini APIè°ƒç”¨æˆåŠŸ');
              const aiReply = response.data.candidates[0].content.parts[0].text.trim();

              // å‘å¸ƒAIå›å¤åˆ°Issue
              console.log('å¼€å§‹å‘å¸ƒè¯„è®ºåˆ°Issue...');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ğŸ¤– Gemini AI å›å¤ï¼š\n\n${aiReply}`
              });
              console.log('è¯„è®ºå‘å¸ƒæˆåŠŸ');
            } catch (error) {
              console.error('å¤„ç†å¤±è´¥:', error);
              // å…œåº•å›å¤ï¼ˆAPIè°ƒç”¨å¤±è´¥æ—¶ï¼‰
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: "ğŸ¤– æŠ±æ­‰ï¼Œæš‚æ—¶æ— æ³•ç”Ÿæˆå›å¤ï½å¯å‚è€ƒä»“åº“å®˜æ–¹æ–‡æ¡£ï¼ˆhttps://ais-bench-benchmark-rf.readthedocs.io/ï¼‰æˆ–å†å²Issueï¼Œæˆ–ç¨åé‡è¯•ã€‚"
              });
            }